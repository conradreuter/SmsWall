<!doctype html>
<html>
<head>
  <meta charset="utf8">
  <title>SMS Wall</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.2/react.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.2/react-dom.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/locale/de.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1 id="welcome-message">SMS Wall</h1>
  <div id="sms-wall"></div>
  <script>
    var socket = io.connect('http://localhost:8080');

    socket.on('welcome', function(welcomeMessage) {
      document.getElementById('welcome-message').textContent = welcomeMessage;
    });

    var SmsWall = React.createClass({
      getInitialState: function() {
        return {messages: []};
      },
      componentWillMount: function() {
        socket.on('messages', this.setMessages);
      },
      setMessages: function(messages) {
        messages.sort(function(x, y) { return x.timestamp - y.timestamp; });
        this.setState({messages: messages});
      },
      render: function() {
        var messages = this.state.messages;
        return React.createElement(SmsList, {messages: messages});
      }
    });

    var SmsList = React.createClass({
      render: function() {
        var smsEntries = this.props.messages.map(function(msg) {
          return React.createElement(SmsEntry, {key: msg.id, message: msg});
        });
        return React.createElement('ul', {}, smsEntries);
      }
    });

    var SmsEntry = React.createClass({
      componentDidMount: function() {
        this.interval = setInterval(this.forceUpdate.bind(this), 30000);
      },
      componentWillUnmount: function() {
        clearInterval(this.interval);
      },
      render: function() {
        var text = this.props.message.text;
        var time = moment(this.props.message.timestamp).fromNow();
        return React.createElement('li', {}, [
          React.createElement('div', {className: 'time', key: 'time'}, time),
          React.createElement('div', {className: 'text', key: 'text'}, text)
        ]);
      }
    });

    ReactDOM.render(
      React.createElement(SmsWall, null),
      document.getElementById('sms-wall')
    );
  </script>
</body>
</html>
